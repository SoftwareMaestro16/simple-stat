import TelegramBot from 'node-telegram-bot-api';
import cron from 'node-cron';
import dotenv from 'dotenv';
import fs from 'fs';
import path from 'path';
import { generateImage } from './src/generateImage/generate.js';

dotenv.config();

const bot = new TelegramBot(process.env.BOT_TOKEN, { polling: true });
const CHANNEL_ID = '-1002429972793';

const keyboard = {
    reply_markup: {
        inline_keyboard: [
            [{ text: 'ðŸ“Š GeckoTerminal ðŸ“š', url: 'https://www.geckoterminal.com/ru/ton/pools/EQCfCyLLCOq_bw_Ge1C1pMlSo7dqFUVSsmNKP4osxoxTxCZo' }],
            [{ text: 'ðŸ’¸ Swap DeDust ðŸª™', url: 'https://dedust.io/swap/TON/EQB9QBqniFI0jOmw3PU6v1v4LU3Sivm9yPXDDB9Qf7cXTDft' }]
        ]
    }
};

function deleteImage(filePath) {
    try {
        if (fs.existsSync(filePath)) {
            fs.unlinkSync(filePath);
            console.log(`ðŸ—‘ Ð¤Ð°Ð¹Ð» ÑƒÐ´Ð°Ð»Ñ‘Ð½: ${filePath}`);
        }
    } catch (error) {
        console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ñ„Ð°Ð¹Ð»Ð°: ${error}`);
    }
}

bot.onText(/\/start/, async (msg) => {
    const chatId = msg.chat.id;

    try {
        console.log(`ðŸ“© Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${chatId}...`);
        const imagePath = await generateImage();

        if (fs.existsSync(imagePath)) {
            await bot.sendPhoto(chatId, fs.createReadStream(imagePath), {
                caption: 'ðŸ“Š ÐÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ',
                ...keyboard
            });
            console.log(`âœ… Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ${chatId}`);
        } else {
            console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¤Ð°Ð¹Ð» Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.');
            bot.sendMessage(chatId, 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ.');
        }

        deleteImage(imagePath); 
    } catch (error) {
        console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ:', error);
        bot.sendMessage(chatId, 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ.');
    }
});

async function sendImageToChannel() {
    try {
        console.log('â³ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ...');
        const imagePath = await generateImage();

        if (fs.existsSync(imagePath)) {
            await bot.sendPhoto(CHANNEL_ID, fs.createReadStream(imagePath), {
                ...keyboard
            });
            console.log('âœ… Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð² ÐºÐ°Ð½Ð°Ð».');
        } else {
            console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¤Ð°Ð¹Ð» Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.');
        }

        deleteImage(imagePath); 
    } catch (error) {
        console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ:', error);
    }
}

cron.schedule('0 7 * * *', async () => {
    await sendImageToChannel();
});

cron.schedule('10 19 * * *', async () => {
    await sendImageToChannel();
});

console.log('ðŸ¤– Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!');